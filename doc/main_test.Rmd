---
title: "Project 3 - Example Main Script"
author: "Chengliang Tang, Tian Zheng"
output: html_notebook
---

```{r}
if(!require("EBImage")){
  source("https://bioconductor.org/biocLite.R")
  biocLite("EBImage")
} 

if(!require("gbm")){
  install.packages("gbm")
}

library("EBImage")
library("gbm")
```

### Step 0: specify directories.
```{r wkdir, eval=FALSE}
set.seed(2018)
setwd("../") 
# here replace it with your own path or manually set it in RStudio to where this rmd file is located. 
# use relative path for reproducibility
```
```{r}
train_dir <- "../train_set/" # This will be modified for different data sets.
train_LR_dir <- paste(train_dir, "LR/", sep="")
train_HR_dir <- paste(train_dir, "HR/", sep="")
train_label_path <- paste(train_dir, "label.csv", sep="") 
SR_dir <- paste(train_dir, "SR/", sep="")
```

### Step 1: set up controls for evaluation experiments.
```{r exp_setup}
run.cv=TRUE # run cross-validation on the training set
K <- 5  # number of CV folds
run.feature.train=TRUE # process features for training set
run.test=TRUE # run evaluation on an independent test set
run.feature.test=TRUE # process features for test set
```
```{r model_setup}
model_values <- seq(3, 11, 2)
model_labels = paste("GBM with depth =", model_values)
```

### Step 2: import training images class labels.
```{r train_label}
extra_label <- read.csv(train_label_path, colClasses=c("NULL", NA, NA))
```

### Step 3: construct features and responses
```{r feature}
source("../lib/feature2.R")
tm_feature_train <- NA
if(run.feature.train){
  tm_feature_train <- system.time(dat_train <- feature(train_LR_dir, train_HR_dir))
  feat_train <- dat_train$feature
  label_train <- dat_train$label
}

#save(dat_train, file="./output/feature_train.RData")
```

#################
### Step 4: Train a classification model with training images
```{r loadlib}
source("../lib/train.R")
source("../lib/test.R")
```
```{r runcv, message=FALSE, warning=FALSE}
source("../lib/cross_validation.R")

if(run.cv){
  err_cv <- array(dim=c(length(model_values), 2))
  for(k in 1:length(model_values)){
    cat("k=", k, "\n")
    err_cv[k,] <- cv.function(feat_train, label_train, model_values[k], K)
  }
  save(err_cv, file="../output/err_cv.RData")
}


```

Visualize cross-validation results. 
```{r cv_vis}
if(run.cv){
  load("../output/err_cv.RData")
  plot(model_values, err_cv[,1], xlab="Interaction Depth", ylab="CV Error",
       main="Cross Validation Error", type="n", ylim=c(0, 0.25))
  points(model_values, err_cv[,1], col="blue", pch=16)
  lines(model_values, err_cv[,1], col="blue")
  arrows(model_values, err_cv[,1]-err_cv[,2], model_values, err_cv[,1]+err_cv[,2], 
        length=0.1, angle=90, code=3)
}
```


* Choose the "best"" parameter value
```{r best_model}
model_best=model_values[1]
if(run.cv){
  model_best <- model_values[which.min(err_cv[,1])]
}

par_best <- list(depth=model_best)
```
###########################
* Train the model with the entire training set using the selected model (model parameter) via cross-validation.
```{r final_train}
tm_train=NA
tm_train <- system.time(fit_train <- train(feat_train, label_train, par_best))
tm_train <- system.time(fit_train <- train(feat_train[150000, , ], label_train[150000, , ]))

#tm_train <- system.time(fit_train <- xgb_train(feat_train, label_train))


save(fit_train, file="../output/fit_train.RData")
```


### Step 5: Super-resolution for test images

```{r superresolution}
source("../lib/superResolution.R")
# test_dir <- "../data/test_set/" # This will be modified for different data sets.
# test_LR_dir <- paste(test_dir, "LR/", sep="")
# test_HR_dir <- paste(test_dir, "HR/", sep="")

tm_test=NA
if(run.test){
  load(file="../output/fit_train.RData")
  tm_test <- system.time(superResolution(train_LR_dir, train_HR_dir, fit_train))
}
```


```{r running_time}
cat("Time for constructing training features=", tm_feature_train[1], "s \n")
#cat("Time for constructing testing features=", tm_feature_test[1], "s \n")
#cat("Time for training model=", tm_train[1], "s \n")
cat("Time for super-resolution=", tm_test[1], "s \n")
```

